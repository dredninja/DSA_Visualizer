<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Binary Tree Visualizer</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background-color: #f4f6f8;
      font-family: 'Arial', sans-serif;
    }
    .container {
      max-width: 1000px;
      margin-top: 50px;
      background-color: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
    }
    h2 {
      color: #333;
      font-size: 32px;
      margin-bottom: 30px;
    }
    .back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 16px;
    }
    .back-button:hover {
      background-color: #0056b3;
    }
    .controls {
      margin-top: 30px;
    }
    .controls input {
      width: 150px;
      margin: 5px;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
    }
    .controls button {
      margin: 5px;
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
    }
    svg {
      width: 100%;
      height: 70vh;
      border: 1px solid #ccc;
      margin-top: 30px;
      border-radius: 8px;
      background-color: #fafafa;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'datastructures' %}" class="back-button">Back to Data Structures</a>
    <h2>Binary Tree Visualizer</h2>

    <div class="controls">
      <input type="number" id="nodeValue" placeholder="Value">
      <button class="btn btn-success" id="insertBtn">Insert</button>
      <button class="btn btn-danger" id="deleteBtn">Delete</button>
      <button class="btn btn-warning" id="clearBtn">Clear</button>
    </div>

    <svg id="treeSvg"></svg>
  </div>

  <script>
let treeData = null;
let previousNodes = new Set();

function initTree() {
  fetch('/api/tree/')
    .then(response => response.json())
    .then(data => {
      treeData = data;
      previousNodes = new Set();
      collectNodeValues(treeData, previousNodes);
      drawTree(treeData);
    });
}

function collectNodeValues(node, set) {
  if (!node) return;
  set.add(node.value);
  for (let child of node.children || []) {
    collectNodeValues(child, set);
  }
}

async function insertNode() {
  const value = parseInt(document.getElementById("nodeValue").value);
  if (!value) return;

  if (!treeData) {
    await sendInsert(value);
    return;
  }

  // simulate comparison path
  const path = [];
  let current = treeData;
  while (current) {
    path.push(current.value);

    let left = null, right = null;

    if (current.children) {
      for (let c of current.children) {
        if (c.value < current.value) left = c;
        if (c.value > current.value) right = c;
      }
    }

    if (value < current.value) {
      if (left) {
        current = left;
      } else break;
    } else if (value > current.value) {
      if (right) {
        current = right;
      } else break;
    } else {
      return; // duplicate
    }
  }

  // animate highlight path
  for (let v of path) {
    highlightNode(v, "yellow");
    await sleep(500);
  }

  await sendInsert(value);
}

function highlightNode(value, color = "yellow") {
  d3.selectAll("circle")
    .filter(d => d.data.value === value)
    .transition()
    .duration(300)
    .style("fill", color)
    .transition()
    .delay(300)
    .style("fill", "#4CAF50");
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function sendInsert(value) {
  await fetch('/api/tree/insert/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ value })
  })
  .then(response => response.json())
  .then(data => {
    const newNodes = new Set();
    collectNodeValues(data, newNodes);
    const addedNodes = [...newNodes].filter(v => !previousNodes.has(v));
    previousNodes = newNodes;
    treeData = data;
    drawTree(treeData, addedNodes);
    document.getElementById("nodeValue").value = "";
  });
}

async function deleteNode() {
  const value = parseInt(document.getElementById("nodeValue").value);
  if (!value) return;

  // Highlight the node to delete in red first
  highlightNode(value, "red");

  // Wait for highlight animation before sending delete request
  await sleep(800);

  await fetch('/api/tree/delete/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ value })
  })
  .then(response => response.json())
  .then(async data => {
    // Animate shrinking the deleted node's circle
    await animateDeleteNode(value);

    previousNodes = new Set();
    collectNodeValues(data, previousNodes);
    treeData = data;
    drawTree(treeData);
    document.getElementById("nodeValue").value = "";
  });
}

// Animate shrinking the deleted node circle before redraw
async function animateDeleteNode(value) {
  const circle = d3.selectAll("circle").filter(d => d.data.value === value);
  if (!circle.empty()) {
    circle
      .transition()
      .duration(600)
      .attr("r", 0);
    await sleep(600);
  }
}

async function clearTree() {
  await fetch('/api/tree/clear/', { method: 'POST' })
  .then(response => response.json())
  .then(data => {
    previousNodes = new Set();
    treeData = data;
    drawTree(treeData, []);
    document.getElementById("nodeValue").value = "";
  });
}

function drawTree(data, highlightNodes = []) {
  const svg = d3.select("#treeSvg");
  svg.selectAll("*").remove();
  if (!data) return;

  const width = svg.node().getBoundingClientRect().width;
  const height = svg.node().getBoundingClientRect().height;

  const g = svg.append("g");

  const treeLayout = d3.tree()
      .nodeSize([120, 100])  // [xSpacing, ySpacing]
      .separation(() => 1.4);

  const root = d3.hierarchy(data, d => d.children);
  treeLayout(root);

  // recenter by shifting x by half the width
  const xOffset = width / 2;
  const yOffset = 40;
  g.attr("transform", `translate(${xOffset},${yOffset})`);

  const zoom = d3.zoom()
      .scaleExtent([0.5, 2])
      .on("zoom", (event) => g.attr("transform", event.transform));
  svg.call(zoom);

  // draw links
  g.selectAll(".link")
      .data(root.links())
      .enter()
      .append("line")
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y)
      .attr("stroke", "#555");

  // draw nodes
  const node = g.selectAll(".node")
      .data(root.descendants())
      .enter()
      .append("g")
      .attr("transform", d => `translate(${d.x},${d.y})`);

  node.append("circle")
      .attr("r", 0)
      .style("fill", d => highlightNodes.includes(d.data.value) ? "orange" : "#4CAF50")
      .transition()
      .duration(800)
      .attr("r", 20);

  node.append("text")
      .attr("dy", 5)
      .attr("text-anchor", "middle")
      .style("fill", "white")
      .style("font-weight", "bold")
      .style("opacity", 0)
      .text(d => d.data.value)
      .transition()
      .duration(800)
      .style("opacity", 1);
}

window.addEventListener('resize', () => drawTree(treeData));
document.getElementById("insertBtn").addEventListener("click", insertNode);
document.getElementById("deleteBtn").addEventListener("click", deleteNode);
document.getElementById("clearBtn").addEventListener("click", clearTree);

initTree();
  </script>
</body>
</html>





